<link rel="stylesheet" href="/styles/library.css">

<div class="library-container">
    
    <div class="library-header">
        <h1>Chord Library</h1>
        <a href="/add-chord" class="btn-add">
            <i class="fa-solid fa-plus"></i> Add New
        </a>
    </div>

    <div class="search-bar">
        <input type="text" placeholder="Search chord (e.g. C Major)...">
        <button><i class="fa-solid fa-search"></i></button>
    </div>

    <div class="chords-grid">
        <?php foreach ($chords as $chord): ?>
            
            <?php $isSystem = empty($chord['author_id']); ?>

            <div class="chord-card <?= $isSystem ? 'system-card' : 'user-card' ?>">
                
                <div class="card-badges">
                    <?php if($isSystem): ?>
                        <span class="badge system">
                            <i class="fa-solid fa-globe"></i> Public
                        </span>
                    <?php else: ?>
                        <span class="badge private">
                            <i class="fa-solid fa-user-lock"></i> Private
                        </span>
                    <?php endif; ?>
                </div>

                <h3><?= $chord['name'] ?></h3>
                
                <div class="canvas-wrapper">
                    <canvas class="chord-canvas" 
                            width="200" 
                            height="240"
                            data-chord='<?= $chord['chord_diagram'] ?>'>
                    </canvas>
                </div>

                <div class="card-actions">
                    <?php if(!$isSystem): ?>
                        <form action="/delete-chord" method="POST" onsubmit="return confirm('Are you sure you want to delete this chord?');">
                            <input type="hidden" name="id" value="<?= $chord['id'] ?>">
                            <button type="submit" class="btn-delete">
                                <i class="fa-solid fa-trash"></i> Delete
                            </button>
                        </form>
                    <?php else: ?>
                        <span class="info-text">System Chord</span>
                    <?php endif; ?>
                </div>

            </div>

        <?php endforeach; ?>
    </div>
</div>

<script src="/scripts/chordDrawer.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const canvases = document.querySelectorAll('.chord-canvas');
        canvases.forEach(canvas => {
            try {
                const data = JSON.parse(canvas.dataset.chord);
                new ChordDrawer(canvas, data);
            } catch (e) {
                console.error("Drawing error:", e);
            }
        });
    });

    // Live Search
    const searchInput = document.querySelector('.search-bar input');
    if (searchInput) {
        searchInput.addEventListener('keyup', function(e) {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('.chord-card').forEach(card => {
                const title = card.querySelector('h3').innerText.toLowerCase();
                card.style.display = title.includes(term) ? "flex" : "none";
            });
        });
    }
</script>